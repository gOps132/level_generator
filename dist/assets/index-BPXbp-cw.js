(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const f of i.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&r(f)}).observe(document,{childList:!0,subtree:!0});function l(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(t){if(t.ep)return;t.ep=!0;const i=l(t);fetch(t.href,i)}})();class E{constructor(e){this.scene=e,this.tileSize=40}moveEntity(e,l,r){if(!e.active)return!1;const t=this.getGridPosition(e.x,e.y),i={x:t.x,y:t.y};return l==="left"&&i.x--,l==="right"&&i.x++,l==="up"&&i.y--,l==="down"&&i.y++,this.isBlocked(i,r)?!1:(e.currGridX=i.x,e.currGridY=i.y,this.scene.tweens.add({targets:e,x:i.x*this.tileSize+this.tileSize/2,y:i.y*this.tileSize+this.tileSize/2,duration:150,ease:"Linear"}),!0)}isBlocked(e,l){return e.y<0||e.y>=l.length||e.x<0||e.x>=l[0].length||l[e.y][e.x]===1}getGridPosition(e,l){return{x:Math.floor(e/this.tileSize),y:Math.floor(l/this.tileSize)}}}class I{constructor(){}generate(e,l,r){let t=0;const i=200;for(;t<i;){t++;const{past:d,future:p,start:c,goal:v}=this.tryGenerate(e,l,r),S=this.solveLevel(d,p,c,v);if(S)return this.pruneToSolution(d,p,c,v,S.path),console.log(`Level generated successfully after ${t} attempts. Min Moves: ${S.steps}`),{past:d,future:p,start:c,goal:v,minMoves:S.steps,solutionPath:S.path}}console.warn("Could not generate complex solvable level, returning empty room.");const f=this.createEmptyGrid(e,l),n={x:1,y:1},o={x:e-2,y:l-2};e>2&&l>2&&(f[n.y][n.x]=2,f[o.y][o.x]=4);const u=Math.abs(n.x-o.x),s=Math.abs(n.y-o.y);let y=[];for(let d=0;d<Math.abs(o.x-n.x);d++)y.push(o.x>n.x?"right":"left");for(let d=0;d<Math.abs(o.y-n.y);d++)y.push(o.y>n.y?"down":"up");return{past:f,future:f,start:n,goal:o,minMoves:u+s,solutionPath:y}}tryGenerate(e,l,r){const t=this.createEmptyGrid(e,l),i=this.createEmptyGrid(e,l),f=.1+r*.03;for(let a=0;a<l;a++)for(let h=0;h<e;h++)Math.random()<f&&(t[a][h]=1);for(let a=0;a<l;a++)for(let h=0;h<e;h++){const x=t[a][h];let z=x;x===1&&Math.random()<.3&&(z=0),x===0&&Math.random()<.02*r&&(z=1),i[a][h]=z}const n=this.findEmptySpot(t);t[n.y][n.x]=2,i[n.y][n.x]===1&&(i[n.y][n.x]=0),i[n.y][n.x]=2;const o=this.findEmptySpot(t);t[o.y][o.x]=4,i[o.y][o.x]===1&&(i[o.y][o.x]=0),i[o.y][o.x]=4;const u=[n,o],s=this.findEmptySpot(t,u);t[s.y][s.x]=5,u.push(s);const d=[{x:s.x,y:s.y-1},{x:s.x,y:s.y+1},{x:s.x-1,y:s.y},{x:s.x+1,y:s.y}].filter(a=>a.x>=0&&a.x<e&&a.y>=0&&a.y<l).filter(a=>!(a.x===n.x&&a.y===n.y)&&!(a.x===o.x&&a.y===o.y));if(d.length>0){const a=Math.floor(Math.random()*d.length),h=d[a];d.forEach(x=>{x!==h&&(t[x.y][x.x]=1)}),t[h.y][h.x]=9,i[h.y][h.x]=1}const p=this.findEmptySpot(t,u);t[p.y][p.x]=8,u.push(p);const c=this.findEmptySpot(t,u);t[c.y][c.x]=7,i[c.y][c.x]===1&&(i[c.y][c.x]=0),i[c.y][c.x]=7;const S=[{x:o.x,y:o.y-1},{x:o.x,y:o.y+1},{x:o.x-1,y:o.y},{x:o.x+1,y:o.y}].filter(a=>a.x>=0&&a.x<e&&a.y>=0&&a.y<l),m=S.filter(a=>!(a.x===n.x&&a.y===n.y));if(m.length>0){const a=Math.floor(Math.random()*m.length),h=m[a];S.forEach(x=>{x.x===n.x&&x.y===n.y||(i[x.y][x.x]=1)}),i[h.y][h.x]=6}return{past:t,future:i,start:n,goal:o}}pruneToSolution(e,l,r,t,i){const f=e.length,n=e[0].length,o=new Set,u=new Set;o.add(`${r.x},${r.y}`),u.add(`${r.x},${r.y}`),o.add(`${t.x},${t.y}`),u.add(`${t.x},${t.y}`);let s=r.x,y=r.y,d=r.x,p=r.y,c=!1,v=!1,S=!1,m=!1;for(const a of i){let h=0,x=0;a==="up"&&(x=-1),a==="down"&&(x=1),a==="left"&&(h=-1),a==="right"&&(h=1);let z=s+h,w=y+x,g=!1;if(z<0||z>=n||w<0||w>=f)z=s,w=y,g=!0;else{const P=e[w][z];P===1&&(g=!0),P===9&&!m&&(g=!0)}if(!g){s=z,y=w,o.add(`${s},${y}`);const P=e[y][s];P===5&&(c=!0),P===7&&c&&(c=!1,v=!0),P===8&&!m&&(m=!0)}let T=d+h,O=p+x,G=!1;if(T<0||T>=n||O<0||O>=f)T=d,O=p,G=!0;else{const P=l[O][T];P===1&&(G=!0),P===6&&!S&&(G=!0),P===9&&!m&&(G=!0)}G||(d=T,p=O,u.add(`${d},${p}`),l[p][d]===7&&v&&!S&&(S=!0))}for(let a=0;a<f;a++)for(let h=0;h<n;h++){const x=e[a][h];[5,6,7,8,9].includes(x)&&o.add(`${h},${a}`);const z=l[a][h];[5,6,7,8,9].includes(z)&&u.add(`${h},${a}`)}for(let a=0;a<f;a++)for(let h=0;h<n;h++)o.has(`${h},${a}`)||e[a][h]===0&&(e[a][h]=1),u.has(`${h},${a}`)||l[a][h]===0&&(l[a][h]=1)}solveLevel(e,l,r,t){const i=e[0].length,f=e.length,n=[];n.push({px:r.x,py:r.y,fx:r.x,fy:r.y,hasKey:!1,deposited:!1,futureHasKey:!1,leverOn:!1,steps:0,path:[]});const o=new Set,u=s=>`${s.px},${s.py},${s.fx},${s.fy},${s.hasKey?1:0},${s.deposited?1:0},${s.futureHasKey?1:0},${s.leverOn?1:0}`;for(o.add(u(n[0]));n.length>0;){const s=n.shift();if(s.px===t.x&&s.py===t.y&&s.fx===t.x&&s.fy===t.y)return{steps:s.steps,path:s.path};const y=[{dx:0,dy:-1,name:"up"},{dx:0,dy:1,name:"down"},{dx:-1,dy:0,name:"left"},{dx:1,dy:0,name:"right"}];for(const d of y){let p=s.px+d.dx,c=s.py+d.dy,v=s.hasKey,S=s.deposited,m=s.leverOn;if(p<0||p>=i||c<0||c>=f)p=s.px,c=s.py;else{const g=e[c][p];let T=!1;g===1&&(T=!0),g===9&&!m&&(T=!0),T?(p=s.px,c=s.py):(g===5&&!v&&!S&&(v=!0),g===7&&v&&(v=!1,S=!0),g===8&&!m&&(m=!0))}let a=s.fx+d.dx,h=s.fy+d.dy,x=s.futureHasKey;if(a<0||a>=i||h<0||h>=f)a=s.fx,h=s.fy;else{let g=l[h][a],T=!1;g===1&&(T=!0),g===6&&!x&&(T=!0),g===9&&!m&&(T=!0),T?(a=s.fx,h=s.fy):g===7&&S&&!x&&(x=!0)}if(p===s.px&&c===s.py&&a===s.fx&&h===s.fy&&v===s.hasKey&&S===s.deposited&&x===s.futureHasKey&&m===s.leverOn)continue;const z={px:p,py:c,fx:a,fy:h,hasKey:v,deposited:S,futureHasKey:x,leverOn:m,steps:s.steps+1,path:[...s.path,d.name]},w=u(z);o.has(w)||(o.add(w),n.push(z))}}return null}createEmptyGrid(e,l){const r=[];for(let t=0;t<l;t++)r[t]=new Array(e).fill(0);return r}findEmptySpot(e,l=[]){let r,t,i=0;const f=100;do{r=Math.floor(Math.random()*e[0].length),t=Math.floor(Math.random()*e.length),i++;let n=!1;for(const o of l)o.x===r&&o.y===t&&(n=!0);if(!n&&e[t][r]===0)return{x:r,y:t}}while(i<f);return{x:0,y:0}}}class C extends Phaser.Scene{constructor(){super({key:"GameScene"}),this.tileSize=40,this.cols=15,this.rows=15}preload(){const e=this.make.graphics({x:0,y:0,add:!1});e.fillStyle(0),e.fillRect(0,0,this.tileSize,this.tileSize),e.lineStyle(1,1118481,1),e.strokeRect(0,0,this.tileSize,this.tileSize),e.generateTexture("wall",this.tileSize,this.tileSize),e.clear(),e.fillStyle(43775),e.fillRect(5,5,this.tileSize-10,this.tileSize-10),e.generateTexture("player_past",this.tileSize,this.tileSize),e.clear(),e.fillStyle(11141375),e.fillRect(5,5,this.tileSize-10,this.tileSize-10),e.generateTexture("player_future",this.tileSize,this.tileSize),e.clear(),e.fillStyle(65280),e.fillCircle(this.tileSize/2,this.tileSize/2,this.tileSize/3),e.generateTexture("goal",this.tileSize,this.tileSize),e.clear(),e.fillStyle(2236962),e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle(3355443),e.fillRect(1,1,this.tileSize-2,this.tileSize-2),e.generateTexture("floor",this.tileSize,this.tileSize),e.clear(),e.fillStyle(16776960),e.fillCircle(this.tileSize/2,this.tileSize/2,this.tileSize/4),e.generateTexture("key",this.tileSize,this.tileSize),e.clear(),e.fillStyle(9127187),e.fillRect(5,5,this.tileSize-10,this.tileSize-10),e.generateTexture("chest",this.tileSize,this.tileSize),e.clear(),e.fillStyle(16766720),e.fillRect(5,5,this.tileSize-10,this.tileSize-10),e.generateTexture("chest_full",this.tileSize,this.tileSize),e.clear(),e.fillStyle(16711680),e.fillRect(0,0,this.tileSize,this.tileSize),e.generateTexture("door",this.tileSize,this.tileSize),e.clear(),e.fillStyle(4473924),e.fillRect(5,25,30,10),e.fillStyle(16711680),e.fillRect(10,5,5,20),e.generateTexture("lever_off",this.tileSize,this.tileSize),e.clear(),e.fillStyle(4473924),e.fillRect(5,25,30,10),e.fillStyle(65280),e.fillRect(25,5,5,20),e.generateTexture("lever_on",this.tileSize,this.tileSize),e.clear(),e.fillStyle(3355443),e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle(8947848),e.fillRect(5,0,5,40),e.fillRect(15,0,5,40),e.fillRect(25,0,5,40),e.generateTexture("gate_closed",this.tileSize,this.tileSize),e.clear(),e.fillStyle(2236962),e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle(3355443),e.fillRect(1,1,this.tileSize-2,this.tileSize-2),e.fillStyle(5592405),e.fillRect(0,35,40,5),e.generateTexture("gate_open",this.tileSize,this.tileSize)}create(){this.physicsSystem=new E(this),this.levelGenerator=new I,this.pastContainer=this.add.container(0,0),this.futureContainer=this.add.container(0,0),this.stepsLeft=50,this.updateCounterUI(),document.getElementById("generate-btn").onclick=()=>{this.generateLevel(),this.game.canvas.focus()};const e=document.getElementById("reset-btn");e&&(e.onclick=()=>{this.resetLevelState(),this.game.canvas.focus()});const l=document.getElementById("difficulty-slider");l.oninput=i=>{document.getElementById("difficulty-val").innerText=i.target.value};const r=document.getElementById("room-size-slider");r.oninput=i=>{const f=["Small","Medium","Large"];document.getElementById("room-size-val").innerText=f[i.target.value-1]},document.getElementById("save-btn").onclick=()=>this.saveLevel();const t=document.getElementById("save-dropdown");t.onchange=i=>{i.target.value!==""&&(this.loadLevel(i.target.value),i.target.value="",this.game.canvas.focus())},this.updateSaveDropdown(),this.input.keyboard.on("keydown-W",()=>this.handleInput("up")),this.input.keyboard.on("keydown-A",()=>this.handleInput("left")),this.input.keyboard.on("keydown-S",()=>this.handleInput("down")),this.input.keyboard.on("keydown-D",()=>this.handleInput("right")),this.generateLevel()}generateLevel(){this.winText&&this.winText.destroy(),this.loseText&&this.loseText.destroy();const e=document.getElementById("difficulty-slider").value,l=parseInt(e),r=document.getElementById("room-size-slider").value,t={1:10,2:15,3:20};this.cols=t[r],this.rows=t[r];const i=this.levelGenerator.generate(this.cols,this.rows,l);this.levelData=JSON.parse(JSON.stringify(i)),this.startPos=this.levelData.start,this.minMoves=this.levelData.minMoves,this.solutionPath=this.levelData.solutionPath||[],this.updateSolutionUI(),this.setupCamera(),this.resetLevelState()}resetLevelState(){this.stepsLeft=this.minMoves,this.updateCounterUI(),this.isGameOver=!1,this.winText&&this.winText.destroy(),this.loseText&&this.loseText.destroy(),this.winText=null,this.loseText=null,this.hasKey=!1,this.depositedKey=!1,this.futureHasKey=!1,this.leverOn=!1,this.levelData&&(this.pastGrid=JSON.parse(JSON.stringify(this.levelData.past)),this.futureGrid=JSON.parse(JSON.stringify(this.levelData.future)),this.renderGrid(this.pastContainer,this.pastGrid,"past"),this.renderGrid(this.futureContainer,this.futureGrid,"future")),this.playerPast,this.playerPast=this.add.sprite(this.startPos.x*this.tileSize+this.tileSize/2,this.startPos.y*this.tileSize+this.tileSize/2,"player_past"),this.pastContainer.add(this.playerPast),this.playerPast.currGridX=this.startPos.x,this.playerPast.currGridY=this.startPos.y,this.playerFuture=this.add.sprite(this.startPos.x*this.tileSize+this.tileSize/2,this.startPos.y*this.tileSize+this.tileSize/2,"player_future"),this.futureContainer.add(this.playerFuture),this.playerFuture.currGridX=this.startPos.x,this.playerFuture.currGridY=this.startPos.y}renderGrid(e,l,r){e.removeAll(!0);for(let f=0;f<l.length;f++)for(let n=0;n<l[0].length;n++){const o=l[f][n],u=n*this.tileSize+this.tileSize/2,s=f*this.tileSize+this.tileSize/2;if(e.add(this.add.image(u,s,"floor")),o===1)e.add(this.add.image(u,s,"wall"));else if(o===4)e.add(this.add.image(u,s,"goal"));else if(o===5)e.add(this.add.image(u,s,"key"));else if(o===6)e.add(this.add.image(u,s,"door"));else if(o===7){let y="chest";r==="past"&&this.depositedKey&&(y="chest_full"),r==="future"&&this.depositedKey&&!this.futureHasKey&&(y="chest_full"),e.add(this.add.image(u,s,y))}else if(o===8){let y=this.leverOn?"lever_on":"lever_off";e.add(this.add.image(u,s,y))}else if(o===9){let y=this.leverOn?"gate_open":"gate_closed";e.add(this.add.image(u,s,y))}}const t=r==="past"?"PAST (ANCESTOR)":"FUTURE (DESCENDANT)",i=this.add.text(l[0].length*this.tileSize/2,-30,t,{fontSize:"20px",fill:"#fff"}).setOrigin(.5);e.add(i)}handleInput(e){if(this.isGameOver||!this.playerPast||!this.playerFuture)return;let l=0,r=0;e==="left"?l=-1:e==="right"?l=1:e==="up"?r=-1:e==="down"&&(r=1);let t=this.playerPast.currGridX+l,i=this.playerPast.currGridY+r,f=!1;t>=0&&t<this.cols&&i>=0&&i<this.rows&&this.pastGrid[i][t]===9&&!this.leverOn&&(f=!0);let n=!1;f||(n=this.physicsSystem.moveEntity(this.playerPast,e,this.pastGrid));let o=l,u=r,s=this.playerFuture.currGridX+o,y=this.playerFuture.currGridY+u,d=!1;s>=0&&s<this.cols&&y>=0&&y<this.rows&&(this.futureGrid[y][s]===6&&!this.futureHasKey&&(d=!0),this.futureGrid[y][s]===9&&!this.leverOn&&(d=!0));let p=!1;d||(p=this.physicsSystem.moveEntity(this.playerFuture,e,this.futureGrid));let c=!1;if(n){const v=this.playerPast.currGridX,S=this.playerPast.currGridY,m=this.pastGrid[S][v];m===5&&(this.hasKey=!0,this.pastGrid[S][v]=0,c=!0,console.log("Key Picked Up")),m===7&&this.hasKey&&(this.hasKey=!1,this.depositedKey=!0,c=!0,console.log("Key Deposited")),m===8&&(this.leverOn||(this.leverOn=!0,c=!0,console.log("Lever Activated")))}if(p){const v=this.playerFuture.currGridX,S=this.playerFuture.currGridY;this.futureGrid[S][v]===7&&this.depositedKey&&!this.futureHasKey&&(this.futureHasKey=!0,c=!0,console.log("Future Key Retrieved"))}c&&(this.pastContainer.remove(this.playerPast),this.futureContainer.remove(this.playerFuture),this.renderGrid(this.pastContainer,this.pastGrid,"past"),this.renderGrid(this.futureContainer,this.futureGrid,"future"),this.pastContainer.add(this.playerPast),this.futureContainer.add(this.playerFuture)),(n||p)&&(this.stepsLeft--,this.updateCounterUI(),this.checkWinCondition(),!this.isGameOver&&this.stepsLeft<=0&&this.handleLose())}checkWinCondition(){if(!this.playerPast||!this.playerFuture)return;const e=this.pastGrid[this.playerPast.currGridY][this.playerPast.currGridX]===4,l=this.futureGrid[this.playerFuture.currGridY][this.playerFuture.currGridX]===4;e&&l&&(this.isGameOver=!0,this.winText=this.add.text(this.cameras.main.worldView.centerX,this.cameras.main.worldView.centerY,"TIMELINE SYNCED!",{fontSize:"64px",fill:"#00ff00",backgroundColor:"#000000aa",padding:{x:20,y:10}}).setOrigin(.5).setScrollFactor(0))}handleLose(){this.isGameOver=!0,this.loseText=this.add.text(this.cameras.main.worldView.centerX,this.cameras.main.worldView.centerY,"TIME LOST... RESETTING",{fontSize:"64px",fill:"#ff0000",backgroundColor:"#000000aa",padding:{x:20,y:10}}).setOrigin(.5).setScrollFactor(0),this.time.delayedCall(1500,()=>{this.loseText&&this.loseText.destroy(),this.resetLevelState()})}updateCounterUI(){const e=document.getElementById("step-counter");e&&(e.innerText=this.stepsLeft)}saveLevel(){if(this.levelData)try{const e=JSON.parse(localStorage.getItem("timetwins_saves")||"[]"),l=new Date().toLocaleTimeString(),r=`Level ${e.length+1} (${l})`,t={name:r,data:this.levelData,cols:this.cols,rows:this.rows};e.push(t),localStorage.setItem("timetwins_saves",JSON.stringify(e)),this.updateSaveDropdown(),alert(`Level Saved: ${r}`)}catch(e){console.error("Save failed",e),alert("Failed to save level (Storage full?)")}}loadLevel(e){try{const r=JSON.parse(localStorage.getItem("timetwins_saves")||"[]")[e];if(!r)return;this.levelData=r.data,this.cols=r.cols,this.rows=r.rows,this.startPos=this.levelData.start,this.minMoves=this.levelData.minMoves,this.solutionPath=this.levelData.solutionPath||[],this.setupCamera(),this.updateSolutionUI(),this.resetLevelState()}catch(l){console.error("Load failed",l)}}updateSaveDropdown(){const e=document.getElementById("save-dropdown");if(!e)return;e.innerHTML='<option value="">-- Load Saved Level --</option>',JSON.parse(localStorage.getItem("timetwins_saves")||"[]").forEach((r,t)=>{const i=document.createElement("option");i.value=t,i.innerText=r.name,e.appendChild(i)})}setupCamera(){this.futureContainer.x=this.cols*this.tileSize+4,this.separator&&this.separator.destroy(),this.separator=this.add.graphics(),this.separator.lineStyle(2,16777215,.5),this.separator.beginPath(),this.separator.moveTo(this.cols*this.tileSize+4/2,0),this.separator.lineTo(this.cols*this.tileSize+4/2,this.rows*this.tileSize),this.separator.strokePath();const l=this.cols*this.tileSize*2+4,r=this.rows*this.tileSize,t=this.cameras.main;t.centerOn(l/2,r/2);const i=this.cameras.main.width,f=this.cameras.main.height,n=(i-100)/l,o=(f-100)/r;let u=Math.min(n,o,1.2);u<.1&&(u=.1),t.setZoom(u)}updateSolutionUI(){const e=document.getElementById("solution-box");if(e){const r=[];if(this.solutionPath&&this.solutionPath.length>0){let t=this.solutionPath[0],i=1;for(let f=1;f<this.solutionPath.length;f++)this.solutionPath[f]===t?i++:(r.push(i>1?`${t} x${i}`:t),t=this.solutionPath[f],i=1);r.push(i>1?`${t} x${i}`:t),e.innerText=r.join(", ").toUpperCase()}else e.innerText="NO SOLUTION PATH (FALLBACK LEVEL)";e.style.display="none"}const l=document.getElementById("solution-btn");l&&(l.innerText="SHOW SOLUTION",l.onclick=()=>{e.style.display==="none"?(e.style.display="block",l.innerText="HIDE SOLUTION"):(e.style.display="none",l.innerText="SHOW SOLUTION")})}}const $={type:Phaser.AUTO,width:800,height:600,parent:"game-container",backgroundColor:"#1a1a1a",scene:[C],scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{debug:!1}}};new Phaser.Game($);
